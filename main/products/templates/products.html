{% extends "base.html" %}
{% load static %}
{% block title %}Djangocenter Blog List{% endblock %}


{% block css %}
<link href="{% static 'pages/css/inner_pages.rtl.css' %}" rel="stylesheet" />
<link href="{% static 'css/home_1_style.rtl.css' %}" rel="stylesheet" />
{% endblock %}

{% block bodystyle %}
home-style3 sin-prod-pg-1
{% endblock %}

{% block js %}
<script src="{% static 'pages/js/inner_pages.js' %}"></script>

{% endblock %}

{% block content %}
<body class="home-style3">
    <div class="body-container">
      <div class="container container-llgg">
        <main>
          <!--  Start breadcrumb  -->
          <section
            class="tc-breadcrumb-style6 p-30 radius-4 bg-white mt-3 wow fadeInUp"
          >
            <nav aria-label="breadcrumb">
              <ol class="breadcrumb fw-bold mb-0">
                <li class="breadcrumb-item color-999"><a href="#">خانه</a></li>
                <li class="breadcrumb-item color-999">
                  <a href="#">فروشگاه</a>
                </li>
                <li
                  aria-current="page"
                  class="breadcrumb-item active color-000"
                >
                  {{ catname.title }}
                </li>
              </ol>
            </nav>
          </section>
          <!--  End breadcrumb  -->
         
         
          <!--  Start products  -->
          <section
            class="tc-products-style6 p-30 radius-4 bg-white mt-3 wow fadeInUp"
          >
            <div class="row">
              <div class="col-lg-3">
                <div class="filters d-none d-lg-block">
                  <div class="category-box">
                    <h6 class="fsz-18 fw-bold text-uppercase mb-20">دسته</h6>
                    <a
                      class="cat-btn fsz-12 fw-bold py-2 px-3 bg-white radius-3 hover-bg-green2"
                      href="{% url 'products:product_list' %}"
                    >
                      <i class="la la-angle-left me-2"></i>همه دسته بندی ها</a
                    >
                    <div class="cat-list pt-20">
                      <h6 class="fsz-14 fw-bold mb-20">{{ catname.title }}</h6>
                      <ul>
                        <li>
                          <a href="{% url 'products:product_list' %}"
                            ><i class="la la-angle-left">همه محصولات</i></a
                          >
                        </li>
                        {% for cat in categories %}
                        <li><a href="{% url 'products:product_list_by_category' pk=cat.id slug=cat.slug %}">{{ cat.title }}</a></li>
                        {% endfor %}
                      </ul>
                    </div>
                  </div>
                  <div class="filter-box mt-10">
                   
                    <div class="filter-groups">
                      <div class="filter-group">
                        <div class="group-title">
                          <strong class="fsz-14">  برند ها</strong>
                          <span class="arrow">
                            <i class="la la-angle-up"></i>
                          </span>
                        </div>
                        <div class="group-body">
                          
                          <div class="scroll-cont">
                            <div class="check-group check-brands">
                              {% for brand in brands %}
                            <div class="form-check">
                              <input
                                class="form-check-input brand-checkbox"
                                id="brand-{{ brand.id }}"
                                type="checkbox"
                                name="brand"
                                value="{{ brand.name }}"
                                hx-trigger="change"
                              />
                              <label class="form-check-label" for="brand-{{ brand.id }}">
                                <span>{{ brand.name }}</span>
                              </label>
                            </div>
                            {% endfor %}
                  
                            </div>
                          </div>
                        </div>
                      </div>
                      <div class="filter-group">
                        <div class="group-title">
                          <strong class="fsz-14">با قیمت</strong>
                          <span class="arrow">
                            <i class="la la-angle-up"></i>
                          </span>
                        </div>
                        <div class="group-body">
                          <div class="price-card">
                            <div class="slider">
                              <div class="progress"></div>
                            </div>
                            <div class="range-input">
                              <input 
                                name="min_price_display"  
                                class="range-min desktop-filter" 
                                max="{{ price_range.max }}" 
                                min="{{ price_range.min }}" 
                                step="1000" 
                                type="range" 
                                value="{{ price_range.min }}"
                                hx-trigger="change"  
                              />
                              <input 
                                name="max_price_display"  
                                class="range-max desktop-filter" 
                                max="{{ price_range.max }}" 
                                min="{{ price_range.min }}" 
                                step="1000" 
                                type="range" 
                                value="{{ price_range.max }}"
                                hx-trigger="change" 
                              />
                            </div>
                            <div class="row mt-20 align-items-center gx-0">
                              <div class="col-9">
                                <div class="price-input">
                                  <div class="field">
                                    <span class="sympol">تومان</span>
                                    <input
                                      name="min_price_display"  
                                      class="input-min desktop-filter"
                                      type="number"
                                      value="{{ price_range.min }}"
                                      min="{{ price_range.min }}"
                                      max="{{ price_range.max }}"
                                      hx-trigger="change, keyup delay:500ms"  
                                    />
                                  </div>
                                  <div class="separator"></div>
                                  <div class="field">
                                    <span class="sympol">تومان</span>
                                    <input
                                      name="max_price_display"  
                                      class="input-max desktop-filter"
                                      type="number"
                                      value="{{ price_range.max }}"
                                      min="{{ price_range.min }}"
                                      max="{{ price_range.max }}"
                                      hx-trigger="change, keyup delay:500ms"  
                                    />
                                  </div>
                                </div>
                              </div>
                              <div class="col-3 text-end">
                                <button 
                                  type="button" 
                                  class="bttn"
                                  hx-get="{% url 'products:product_partial' %}"
                                  hx-include="#hidden_min_price, #hidden_max_price"
                                  hx-target="#product-list"
                                >
                                  رفتن
                                </button>
                              </div>
                            </div>
                          </div>
                        </div>
                      </div>                   
                    </div>
                  </div>                  
                </div>

                <div class="d-flex align-items-center d-lg-none gap-4">
                    <button class="btn btn-filter text-black d-flex align-items-center lh-1" type="button"
                            data-bs-toggle="offcanvas" data-bs-target="#offcanvasFilter">
                          <i class="fal fa-sliders-h me-2"></i> فیلتر
                    </button>

                <div class="products-content">
                  <div class="prod-filter color-666">
                    <div class="row align-items-center">
                      <div class="col-lg-4 mt-3 mt-lg-0">
                        <div class="sort-item">
                        <span class="s-title">ترتیب</span>
                        <select class="form-control form-select" name="order"
                                hx-get="{% url 'products:product_partial' %}"
                                hx-target="#product-list"
                                hx-trigger="change"
                                hx-include="#hidden_min_price, #hidden_max_price, [name='brand'], [name='category']"
                                hx-indicator="#loading-spinner">
                          
                          <option value="">پیش فرض</option>
                          <option value="-sold_count" {% if request.GET.order == '-sold_count' %}selected{% endif %}>پرفروش‌ترین</option>
                          <option value="-create_at" {% if request.GET.order == '-create_at' %}selected{% endif %}>جدیدترین</option>
                          <option value="price" {% if request.GET.order == 'price' %}selected{% endif %}>ارزان‌ترین</option>
                          <option value="-price" {% if request.GET.order == '-price' %}selected{% endif %}>گران‌ترین</option>
                          
                        </select>
                      </div>
                      </div>
                      <div class="col-lg-2 text-lg-end mt-3 mt-lg-0">
                        </div>
                      </div>
                    </div>
                  </div>
                </div>
              </div>
              <div class="col-lg-9">
                <div class="products-content d-none d-lg-block">
                  <div class="prod-filter color-666">
                    <div class="row align-items-center">
                      <div class="col-lg-4 mt-3 mt-lg-0">
                        <div class="sort-item">
                        <span class="s-title">ترتیب</span>
                        <select class="form-control form-select" name="order"
                                hx-get="{% url 'products:product_partial' %}"
                                hx-target="#product-list"
                                hx-trigger="change"
                                hx-include="#hidden_min_price, #hidden_max_price, [name='brand'], [name='category']"
                                hx-indicator="#loading-spinner">
                          
                          <option value="">پیش فرض</option>
                          <option value="-sold_count" {% if request.GET.order == '-sold_count' %}selected{% endif %}>پرفروش‌ترین</option>
                          <option value="-create_at" {% if request.GET.order == '-create_at' %}selected{% endif %}>جدیدترین</option>
                          <option value="price" {% if request.GET.order == 'price' %}selected{% endif %}>ارزان‌ترین</option>
                          <option value="-price" {% if request.GET.order == '-price' %}selected{% endif %}>گران‌ترین</option>
                          
                        </select>
                      </div>
                      </div>
                      <div class="col-lg-2 text-lg-end mt-3 mt-lg-0">
                        </div>
                      </div>
                    </div>
                  </div>

                  <div class="products">
                    <div class="row">
                        {% if catname %}
                          <input type="hidden" id="cat_slug" name="category" value="{{catname.id}}">
                        {% endif %}
                        
                        <div id="product-list" 
                            hx-get="{% url 'products:product_partial' %}" 
                            hx-trigger="change from:input:not([disabled]), change from:select"
                            hx-include="#hidden_min_price, #hidden_max_price, [name='brand'], [name='category'], [name='order'], [name='search']"
                            hx-indicator="#loading-spinner">
                          {% include 'product_cards.html' %}
                        </div>
                        
                        <div id="loading-spinner" class="htmx-indicator text-center my-5">
                          <div class="custom-spinner"></div>
                          <p class="text-muted mt-2">در حال بارگذاری محصولات...</p>
                        </div>
                      </div>
                    </div>
                    
                  </div>
                </div>
              </div>
            </div>
          </section>
          <!--  End products  -->
          <!--  Start recently  -->
        
          <!--  End recently  -->
        </main>
        <!--End-Contents-->
      </div>
    </div>

    <!-- اضافه کردن فیلدهای مخفی برای ارسال مقادیر واقعی -->
    <input type="hidden" id="hidden_min_price" name="min_price" value="{{ price_range.min }}">
    <input type="hidden" id="hidden_max_price" name="max_price" value="{{ price_range.max }}">

    <!-- اسکریپت برای مدیریت فرم‌های فیلتر -->
    <script>
      document.addEventListener('DOMContentLoaded', function() {
        // فیلدهای مخفی برای ارسال مقادیر واقعی
        const hiddenMinPrice = document.getElementById('hidden_min_price');
        const hiddenMaxPrice = document.getElementById('hidden_max_price');
        
        // تابع برای مدیریت فیلدهای فیلتر بر اساس اندازه صفحه
        function handleFilterForms() {
          const isMobile = window.innerWidth < 992; // همان breakpoint که در Bootstrap برای lg استفاده می‌شود
          
          // فیلدهای دکوری دسکتاپ
          const desktopFilters = document.querySelectorAll('.desktop-filter');
          // فیلدهای دکوری موبایل
          const mobileFilters = document.querySelectorAll('.mobile-filter');
          
          // غیرفعال کردن فرم‌های نامناسب برای نمایش
          desktopFilters.forEach(filter => {
            filter.disabled = isMobile;
            // تبدیل به حالت دکوری
            if (filter.type === 'number') {
              filter.readOnly = true;
            }
          });
          
          mobileFilters.forEach(filter => {
            filter.disabled = !isMobile;
            // تبدیل به حالت دکوری
            if (filter.type === 'number') {
              filter.readOnly = true;
            }
          });
        }
        
        // تابع به‌روزرسانی نوار پیشرفت قیمت در حالت موبایل
        function updateMobilePriceProgress() {
          const mobileMinRange = document.querySelector('.mobile-filter[name="min_price_display"][type="range"]');
          const mobileMaxRange = document.querySelector('.mobile-filter[name="max_price_display"][type="range"]');
          const progressBar = document.getElementById('mobile-price-progress');
          
          if (mobileMinRange && mobileMaxRange && progressBar) {
            const minVal = parseInt(mobileMinRange.value);
            const maxVal = parseInt(mobileMaxRange.value);
            const minPossible = parseInt(mobileMinRange.min);
            const maxPossible = parseInt(mobileMaxRange.max);
            
            // محاسبه درصد برای تنظیم نوار پیشرفت - اصلاح شده برای RTL
            const rightPercent = ((minVal - minPossible) / (maxPossible - minPossible)) * 100;
            const leftPercent = 100 - ((maxVal - minPossible) / (maxPossible - minPossible)) * 100;
            
            // تنظیم استایل نوار پیشرفت
            progressBar.style.right = rightPercent + '%';
            progressBar.style.left = leftPercent + '%';
          }
        }
        
        // تابع برای به‌روزرسانی فیلدهای مخفی و همگام‌سازی فیلدهای دکوری
        function updateHiddenFields(name, value) {
          // به‌روزرسانی فیلدهای مخفی
          if (name === 'min_price_display') {
            hiddenMinPrice.value = value;
          } else if (name === 'max_price_display') {
            hiddenMaxPrice.value = value;
          }
          
          // به‌روزرسانی همه فیلدهای دکوری
          updateAllDisplayFields();
        }
        
        // تابع برای به‌روزرسانی همه فیلدهای دکوری بر اساس مقادیر مخفی
        function updateAllDisplayFields() {
          const minValue = hiddenMinPrice.value;
          const maxValue = hiddenMaxPrice.value;
          
          // به‌روزرسانی فیلدهای دکوری دسکتاپ
          const desktopMinRange = document.querySelector('.desktop-filter[name="min_price_display"][type="range"]');
          const desktopMaxRange = document.querySelector('.desktop-filter[name="max_price_display"][type="range"]');
          const desktopMinInput = document.querySelector('.desktop-filter.input-min');
          const desktopMaxInput = document.querySelector('.desktop-filter.input-max');
          
          if (desktopMinRange) desktopMinRange.value = minValue;
          if (desktopMaxRange) desktopMaxRange.value = maxValue;
          if (desktopMinInput) desktopMinInput.value = minValue;
          if (desktopMaxInput) desktopMaxInput.value = maxValue;
          
          // به‌روزرسانی فیلدهای دکوری موبایل
          const mobileMinRange = document.querySelector('.mobile-filter[name="min_price_display"][type="range"]');
          const mobileMaxRange = document.querySelector('.mobile-filter[name="max_price_display"][type="range"]');
          const mobileMinInput = document.querySelector('.mobile-filter.input-min');
          const mobileMaxInput = document.querySelector('.mobile-filter.input-max');
          
          if (mobileMinRange) mobileMinRange.value = minValue;
          if (mobileMaxRange) mobileMaxRange.value = maxValue;
          if (mobileMinInput) mobileMinInput.value = minValue;
          if (mobileMaxInput) mobileMaxInput.value = maxValue;
          
          // به‌روزرسانی نوار پیشرفت
          updateMobilePriceProgress();
        }
        
        // اضافه کردن رویدادهای تغییر برای همگام‌سازی مقادیر اسلایدرها و فیلدهای عددی
        const priceRanges = document.querySelectorAll('input[type="range"][name="min_price_display"], input[type="range"][name="max_price_display"]');
        
        priceRanges.forEach(range => {
          range.addEventListener('input', function(event) {
            const name = event.target.name;
            const value = event.target.value;
            
            // به‌روزرسانی فیلدهای مخفی و همگام‌سازی فیلدهای دکوری
            updateHiddenFields(name, value);
            
            // به‌روزرسانی فیلد عددی متناظر
            const isMobileFilter = event.target.classList.contains('mobile-filter');
            const correspondingInput = document.querySelector(`input[type="number"]${isMobileFilter ? '.mobile-filter' : '.desktop-filter'}.input-${name.includes('min') ? 'min' : 'max'}`);
            if (correspondingInput) correspondingInput.value = value;
          });
        });
        
        // دکمه‌های «رفتن» برای اعمال فیلترها
        const goButtons = document.querySelectorAll('button.bttn[hx-get]');
        
        goButtons.forEach(button => {
          button.addEventListener('click', function() {
            // اطمینان از اینکه درخواست HTMX با مقادیر به‌روز ارسال می‌شود
            const hxInclude = this.getAttribute('hx-include');
            if (hxInclude && hxInclude.includes('mobile-filter')) {
              // برای درخواست‌های موبایل
              this.setAttribute('hx-include', '#hidden_min_price, #hidden_max_price');
            } else {
              // برای درخواست‌های دسکتاپ
              this.setAttribute('hx-include', '#hidden_min_price, #hidden_max_price');
            }
          });
        });
        
        // اجرای اولیه
        handleFilterForms();
        
        // به‌روزرسانی اولیه نوار پیشرفت قیمت
        setTimeout(updateMobilePriceProgress, 100);
        
        // اجرا در هنگام تغییر اندازه صفحه
        window.addEventListener('resize', function() {
          handleFilterForms();
          setTimeout(updateMobilePriceProgress, 100);
        });
      });
    </script>

    <!-- Offcanvas Filter -->
<div class="offcanvas offcanvas-start" tabindex="-1" id="offcanvasFilter">
  <div class="offcanvas-header">
    <h5 class="offcanvas-title">فیلتر محصولات</h5>
    <button type="button" class="btn-close text-reset" data-bs-dismiss="offcanvas"></button>
  </div>
  <div class="offcanvas-body">
    <div class="filters">
      <div class="category-box">
        <h6 class="fsz-18 fw-bold text-uppercase mb-20">دسته</h6>
        <a class="cat-btn fsz-12 fw-bold py-2 px-3 bg-white radius-3 hover-bg-green2"
           href="{% url 'products:product_list' %}">
          <i class="la la-angle-left me-2"></i>همه دسته بندی ها
        </a>
        <div class="cat-list pt-20">
          <h6 class="fsz-14 fw-bold mb-20">{{ catname.title }}</h6>
          <ul>
            <li>
              <a href="{% url 'products:product_list' %}">
                <i class="la la-angle-left"></i> همه محصولات
              </a>
            </li>
            {% for cat in categories %}
            <li>
              <a href="{% url 'products:product_list_by_category' pk=cat.id slug=cat.slug %}">
                {{ cat.title }}
              </a>
            </li>
            {% endfor %}
          </ul>
        </div>
      </div>

      <div class="filter-box mt-10">
        <div class="filter-groups">
          <div class="filter-group">
            <div class="group-title">
              <strong class="fsz-14">برند ها</strong>
              <span class="arrow">
                <i class="la la-angle-up"></i>
              </span>
            </div>
            <div class="group-body">
              <div class="scroll-cont">
                <div class="check-group check-brands">
                  {% for brand in brands %}
                  <div class="form-check">
                    <input class="form-check-input brand-checkbox"
                           id="brand-{{ brand.id }}"
                           type="checkbox"
                           name="brand"
                           value="{{ brand.name }}"
                           hx-trigger="change" />
                    <label class="form-check-label" for="brand-{{ brand.id }}">
                      <span>{{ brand.name }}</span>
                    </label>
                  </div>
                  {% endfor %}
                </div>
              </div>
            </div>
          </div>

          <div class="filter-group">
            <div class="group-title">
              <strong class="fsz-14">با قیمت</strong>
              <span class="arrow">
                <i class="la la-angle-up"></i>
              </span>
            </div>
            <div class="group-body">
              <div class="price-card">
                <div class="slider">
                  <div class="progress" id="mobile-price-progress"></div>
                </div>
                <div class="range-input">
                  <input name="min_price_display" class="range-min mobile-filter" max="{{ price_range.max }}" min="{{ price_range.min }}" step="1000" type="range"
                         value="{{ price_range.min }}" hx-trigger="change, input delay:500ms" hx-get="{% url 'products:product_partial' %}" hx-target="#product-list" hx-include="#hidden_min_price, #hidden_max_price" />
                  <input name="max_price_display" class="range-max mobile-filter" max="{{ price_range.max }}" min="{{ price_range.min }}" step="1000" type="range"
                         value="{{ price_range.max }}" hx-trigger="change, input delay:500ms" hx-get="{% url 'products:product_partial' %}" hx-target="#product-list" hx-include="#hidden_min_price, #hidden_max_price" />
                </div>
                <div class="row mt-20 align-items-center gx-0">
                  <div class="col-9">
                    <div class="price-input">
                      <div class="field">
                        <span class="sympol">تومان</span>
                        <input name="min_price_display" class="input-min mobile-filter" type="number" value="{{ price_range.min }}"
                               min="{{ price_range.min }}" max="{{ price_range.max }}"
                               hx-trigger="change, keyup delay:500ms" 
                               hx-get="{% url 'products:product_partial' %}" 
                               hx-target="#product-list" 
                               hx-include="#hidden_min_price, #hidden_max_price" />
                      </div>
                      <div class="separator"></div>
                      <div class="field">
                        <span class="sympol">تومان</span>
                        <input name="max_price_display" class="input-max mobile-filter" type="number" value="{{ price_range.max }}"
                               min="{{ price_range.min }}" max="{{ price_range.max }}"
                               hx-trigger="change, keyup delay:500ms" 
                               hx-get="{% url 'products:product_partial' %}" 
                               hx-target="#product-list" 
                               hx-include="#hidden_min_price, #hidden_max_price" />
                      </div>
                    </div>
                  </div>
                  <div class="col-3 text-end">
                    <button type="button" class="bttn"
                            hx-get="{% url 'products:product_partial' %}"
                            hx-include="#hidden_min_price, #hidden_max_price"
                            hx-target="#product-list">
                      رفتن
                    </button>
                  </div>
                </div>
              </div>
            </div>
          </div>                   
        </div>
      </div>
    </div>
  </div>
</div>
  </body>

{% endblock %}